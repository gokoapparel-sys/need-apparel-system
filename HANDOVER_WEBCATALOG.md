# WEBカタログシステム 引き継ぎ資料

作成日: 2025-10-26
最終更新: セッション中断時点

---

## 📋 目次

1. [現在の状況](#現在の状況)
2. [未解決の問題](#未解決の問題)
3. [システム構成](#システム構成)
4. [次に進めること](#次に進めること)
5. [トラブルシューティング](#トラブルシューティング)
6. [重要なファイル一覧](#重要なファイル一覧)

---

## 現在の状況

### ✅ 完了した作業

#### 1. WEBカタログシステムの基本実装
- **管理者用WEBカタログ** (`StaffWebCatalog.tsx`)
  - 展示会情報とカタログアイテム表示
  - ピックアップコード選択/手動入力機能
  - セッションQRコード表示（ピックアップモード開始用）
  - 各商品のQRコード表示
  - チェックボックスで商品選択
  - 選択した商品をピックアップリストに追加
  - 価格情報（$単価、参考売値）表示
  - 印刷対応CSS

- **お客様用WEBカタログ** (`CustomerWebCatalog.tsx`)
  - 展示会情報とカタログアイテム表示
  - 各商品のQRコード表示
  - 基本情報のみ（価格・工場情報なし）
  - ログイン不要（公開ページ）
  - 印刷対応CSS

#### 2. スタイリング
- `webCatalog.css` 作成完了
  - プロフェッショナルなデザイン（グラデーション、影、カード）
  - 管理者用=青系、お客様用=緑系
  - レスポンシブデザイン
  - 印刷用CSS (`@media print`)

#### 3. ルーティング設定
- `/exhibitions/:id/staff-catalog` - 管理者用（認証必要）
- `/exhibitions/:id/customer-catalog` - お客様用（公開）

#### 4. ピックアップ機能の改善
- 既存のピックアップリストから選択
- 新規ピックアップコードを手動入力
- 存在しない場合は自動的に新規作成
- ピックアップ管理と完全連動

#### 5. QRコード機能
- ピックアップセッション開始QR（展示会単位）
- アイテムスキャンQR（商品単位）
- QR生成関数の引数順序を修正済み

---

## 未解決の問題

### 🔴 優先度: 高

#### 問題1: 「カタログを保存」が「保存中...」で止まる

**症状:**
- ExhibitionDetailページで「カタログを保存」ボタンをクリック
- 「保存中...」と表示されたまま処理が完了しない

**デバッグ準備:**
- デバッグコンソール出力を追加済み（`ExhibitionDetail.tsx` 行69-97）
- 以下の情報が出力されるはず：
  ```
  カタログ保存開始
  選択されたアイテムID: [...]
  保存処理を実行中...
  保存完了  ← ここまで表示されるか確認
  再読み込み完了
  finally句実行
  ```

**確認手順:**
1. ブラウザをリフレッシュ（F5）
2. F12でコンソールを開く
3. アイテムを選択して「カタログを保存」をクリック
4. コンソールに表示されるメッセージを確認
5. エラーメッセージ（赤色）がある場合は内容を確認

**考えられる原因:**
- Firebaseの権限エラー
- 認証トークンの期限切れ
- ネットワークエラー
- Firestoreのセキュリティルール

**関連ファイル:**
- `src/pages/exhibitions/ExhibitionDetail.tsx` (行69-97)
- `src/services/exhibitionsService.ts` (行79-89)

---

#### 問題2: WEBカタログにアイテムが表示されない

**症状:**
- StaffWebCatalogにアクセスしても商品が0件

**原因:**
- `Exhibition.catalogItemIds` が空
- ExhibitionDetailで「カタログを保存」が完了していない

**確認方法:**
```javascript
// StaffWebCatalog.tsx にデバッグコード追加済み（行169-172）
console.log('Exhibition:', exhibition)
console.log('Catalog Item IDs:', exhibition.catalogItemIds)
console.log('Items:', items)
console.log('Pickups:', pickups)
```

**表示されるメッセージ:**
- アイテムが0件の場合:
  > 「カタログアイテムが登録されていません」
  > 「展示会詳細ページで『カタログを保存』ボタンを押して、アイテムを登録してください」

**解決方法:**
1. 問題1を先に解決（保存処理を完了させる）
2. ExhibitionDetailで保存が成功したら、WEBカタログに商品が表示されるはず

---

## システム構成

### データフロー

```
┌─────────────────────────────────────────────────────────────┐
│                     展示会管理システム                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 展示会作成 (ExhibitionsList → ExhibitionForm)              │
│     - 展示会コード、名称、期間、場所を登録                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  2. カタログアイテム選定 (ExhibitionDetail)                      │
│     - 商品一覧から展示するアイテムを選択                          │
│     - 「カタログを保存」ボタンで catalogItemIds を保存           │
│     ⚠️ 現在ここで問題発生中                                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  3. WEBカタログ表示                                            │
│                                                               │
│  A) 管理者用 (/exhibitions/:id/staff-catalog)                 │
│     - 全商品表示（価格情報含む）                                │
│     - ピックアップコード選択/入力                               │
│     - チェックボックスで商品選択                                │
│     - 「選択したアイテムを追加」で Pickup.itemIds に保存        │
│     - セッションQR表示                                         │
│     - 各商品にQR表示                                           │
│                                                               │
│  B) お客様用 (/exhibitions/:id/customer-catalog)              │
│     - 全商品表示（価格情報なし）                                │
│     - 各商品にQR表示                                           │
│     - 印刷可能                                                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  4. ピックアップ方法                                           │
│                                                               │
│  【方法1】WEB上で直接選択                                      │
│    1. 管理用WEBカタログにアクセス                              │
│    2. ピックアップコード選択/入力                              │
│    3. チェックボックスで商品選択                               │
│    4. 「選択したアイテムを追加」ボタンで送信                   │
│                                                               │
│  【方法2】QRコードスキャン方式                                 │
│    1. 管理用WEBカタログを印刷                                  │
│    2. ヘッダーの「ピックアップモード開始」QRをスキャン         │
│    3. PickupSessionStartページに遷移                          │
│    4. ピックアップコード選択/入力                              │
│    5. 「セッション開始」                                       │
│    6. PickupScanSessionページで待機                           │
│    7. 各商品の下げ札QRをスキャン                               │
│    8. 自動的にアイテムが追加される                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  5. ピックアップリスト管理 (PickupsList)                        │
│     - お客様ごとのピックアップリストを確認                       │
│     - ピックアップコード単位で管理                              │
│     - Pickup.itemIds に選択された商品IDが保存される             │
└─────────────────────────────────────────────────────────────┘
```

### データ構造

```typescript
// 展示会
Exhibition {
  id: string
  exhibitionCode: string           // "EX2024SS-001"
  exhibitionName: string           // "2024 Spring/Summer 展示会"
  catalogItemIds: string[]         // カタログに含める商品ID配列
  ...
}

// ピックアップリスト
Pickup {
  id: string
  pickupCode: string               // "PU-2024-001"
  customerName: string             // "株式会社サンプル"
  exhibitionId: string             // 展示会ID
  itemIds: string[]                // お客様が選んだ商品ID配列
  ...
}

// アイテム
Item {
  id: string
  itemNo: string                   // 品番
  name: string
  dollarPrice: number
  referencePrice: number
  ...
}
```

---

## 次に進めること

### 1. WEBカタログのアイテム掲載 🔴 優先度: 最高

**目標:**
- ExhibitionDetailで「カタログを保存」が正常に動作すること
- WEBカタログに商品が表示されること

**手順:**
1. **「保存中...」問題の解決**
   - ブラウザコンソールでエラー確認
   - エラーメッセージに応じて対処:
     - 権限エラー → Firestoreルール確認
     - 認証エラー → ログイン状態確認
     - ネットワークエラー → Firebase接続確認

2. **保存が成功したら確認:**
   ```javascript
   // コンソールに以下が表示されるはず
   カタログ保存開始
   選択されたアイテムID: ["item1", "item2", ...]
   保存処理を実行中...
   保存完了
   再読み込み完了
   finally句実行
   ```

3. **WEBカタログで確認:**
   - `/exhibitions/:id/staff-catalog` にアクセス
   - コンソールで `Catalog Item IDs` を確認
   - 商品が表示されることを確認

---

### 2. QRコード機能の確認 🟡 優先度: 高

**確認項目:**

#### A. セッションQRコード
- **場所:** StaffWebCatalog ヘッダー右側
- **URL形式:** `http://localhost:5173/pickup-session-start?ex={展示会ID}`
- **機能:** スキャンするとピックアップセッション開始画面に遷移
- **実装ファイル:** `src/pages/pickups/PickupSessionStart.tsx`

#### B. アイテムQRコード
- **場所:** 各商品カードの下部
- **URL形式:** `http://localhost:5173/scan-item/{商品ID}?ex={展示会ID}`
- **機能:** スキャンするとアクティブなセッションに商品を追加
- **実装ファイル:** `src/pages/pickups/ScanItem.tsx`

**テスト手順:**
1. スマートフォンのQRコードリーダーアプリを起動
2. 画面に表示されたQRコードをスキャン
3. 正しいURLに遷移することを確認

**注意:**
- スマートフォンからアクセスする場合は `localhost` では動作しません
- テストには以下の方法を使用:
  - 同じWi-Fi内でPCのIPアドレスでアクセス
  - または本番環境にデプロイ

---

### 3. ピックアップチェック機能の確認 🟡 優先度: 高

#### A. WEB上で直接選択する方法

**テスト手順:**
1. StaffWebCatalogにアクセス
2. ピックアップコードを入力（例: `PU-TEST-001`）
3. 商品にチェックを入れる（複数可）
4. 「選択したアイテムを追加」ボタンをクリック
5. アラート「○件のアイテムを追加しました」が表示されることを確認

**確認:**
- ピックアップリスト管理画面 (`/pickups`) で確認
- 作成されたピックアップリストに商品が追加されているか

#### B. QRコードスキャン方式

**テスト手順:**
1. StaffWebCatalogを印刷またはスマートフォンで表示
2. セッションQRコードをスキャン
3. ピックアップコード選択/入力
4. 「セッション開始」
5. 各商品のQRコードをスキャン
6. リアルタイムで商品が追加されることを確認

**確認ポイント:**
- セッション画面で「スキャン済みアイテム」が表示される
- 2秒ごとに自動更新される
- 削除ボタンで削除できる

---

### 4. システムのフロー確認 🟢 優先度: 中

#### チェックリスト

**展示会作成フロー:**
- [ ] 展示会一覧ページで「新規登録」ボタン
- [ ] 展示会情報を入力して保存
- [ ] 展示会詳細ページに遷移

**カタログ作成フロー:**
- [ ] 展示会詳細ページでアイテムを選択
- [ ] 「カタログを保存」ボタンをクリック
- [ ] 保存成功メッセージが表示される
- [ ] WEBカタログボタンが表示される

**管理者用WEBカタログフロー:**
- [ ] 「管理者用WEBカタログ」ボタンをクリック
- [ ] 商品一覧が表示される
- [ ] セッションQRが表示される
- [ ] 各商品にQRが表示される
- [ ] ピックアップコード入力欄が表示される
- [ ] チェックボックスが動作する
- [ ] 「選択したアイテムを追加」ボタンが動作する

**お客様用WEBカタログフロー:**
- [ ] 「お客様用WEBカタログ」ボタンをクリック
- [ ] 商品一覧が表示される（価格なし）
- [ ] 各商品にQRが表示される
- [ ] 印刷プレビューが正しく表示される

**ピックアップフロー（方法1）:**
- [ ] ピックアップコードを入力
- [ ] 商品を選択
- [ ] 送信が成功する
- [ ] ピックアップリスト管理で確認できる

**ピックアップフロー（方法2）:**
- [ ] セッションQRをスキャン
- [ ] ピックアップコードを入力
- [ ] セッション開始
- [ ] 商品QRをスキャン
- [ ] リアルタイムで追加される
- [ ] セッション終了で完了

---

## トラブルシューティング

### 問題: 商品が表示されない

**症状:** WEBカタログに「カタログアイテムが登録されていません」と表示

**原因:**
1. `catalogItemIds` が保存されていない
2. ExhibitionDetailで「カタログを保存」が失敗している

**解決策:**
1. F12でコンソールを開く
2. 以下を確認:
   ```javascript
   Catalog Item IDs: []  // 空の場合は保存されていない
   ```
3. ExhibitionDetailに戻って「カタログを保存」を実行
4. 保存成功後、WEBカタログをリフレッシュ

---

### 問題: QRコードが表示されない

**原因:**
1. QRコード生成に失敗
2. 画像URLの生成エラー

**確認:**
```javascript
// コンソールで確認
console.log('Session QR:', sessionQR)
console.log('Item QRs:', itemQRs)
```

**解決策:**
- `qrcode` パッケージがインストールされているか確認
- `npm install qrcode` を実行

---

### 問題: ピックアップが保存されない

**原因:**
1. ピックアップコードが入力されていない
2. アイテムが選択されていない
3. Firestoreの権限エラー

**確認:**
1. アラートメッセージを確認
2. コンソールで「送信エラー」を確認

**解決策:**
- ピックアップコードを入力
- 最低1つの商品を選択
- ブラウザをリフレッシュして再試行

---

### 問題: QRスキャンが動作しない

**原因:**
1. localhostはスマートフォンからアクセスできない
2. セッションが開始されていない

**解決策:**
- PCのローカルIPアドレスでアクセス（例: `http://192.168.1.100:5173`）
- または本番環境にデプロイ
- セッションを先に開始してからスキャン

---

## 重要なファイル一覧

### コンポーネント

| ファイル | 説明 | 行数 |
|---------|------|------|
| `src/pages/exhibitions/ExhibitionDetail.tsx` | 展示会詳細・カタログ選定 | ~600行 |
| `src/pages/exhibitions/StaffWebCatalog.tsx` | 管理者用WEBカタログ | ~320行 |
| `src/pages/exhibitions/CustomerWebCatalog.tsx` | お客様用WEBカタログ | ~125行 |
| `src/pages/pickups/PickupSessionStart.tsx` | セッション開始画面 | ~205行 |
| `src/pages/pickups/PickupScanSession.tsx` | スキャン待機画面 | ~329行 |
| `src/pages/pickups/ScanItem.tsx` | アイテムスキャン処理 | ~283行 |

### スタイル

| ファイル | 説明 |
|---------|------|
| `src/styles/webCatalog.css` | WEBカタログ専用CSS（印刷対応） |

### サービス

| ファイル | 説明 |
|---------|------|
| `src/services/exhibitionsService.ts` | 展示会CRUD操作 |
| `src/services/pickupsService.ts` | ピックアップリストCRUD操作 |
| `src/services/itemsService.ts` | アイテムCRUD操作 |

### ユーティリティ

| ファイル | 説明 |
|---------|------|
| `src/utils/qrCodeGenerator.ts` | QRコード生成関数 |
| `src/utils/pdfGenerators/staffCatalogHTML.ts` | 管理者用PDF生成 |
| `src/utils/pdfGenerators/customerCatalogHTML.ts` | お客様用PDF生成 |

### ルーティング

| ファイル | 説明 |
|---------|------|
| `src/App.tsx` | ルート定義（行20-21, 45, 190-197を確認） |

---

## デバッグ用コマンド

### コンソールで直接確認

```javascript
// 現在の展示会データを確認
console.log('Exhibition:', exhibition)

// カタログアイテムIDを確認
console.log('Catalog Item IDs:', exhibition.catalogItemIds)

// 取得したアイテムを確認
console.log('Items:', items)

// ピックアップリストを確認
console.log('Pickups:', pickups)
```

---

## 再開時のチェックリスト

### 1. 環境確認
- [ ] `npm run dev` でサーバーが起動しているか
- [ ] http://localhost:5173 でアクセスできるか
- [ ] Firebaseに接続できているか（コンソールにエラーがないか）
- [ ] ログインできているか

### 2. 最優先タスク
- [ ] 「カタログを保存」問題の解決
- [ ] コンソールでエラーメッセージを確認
- [ ] エラーに応じて対処

### 3. 動作確認
- [ ] 保存が成功したら、WEBカタログに商品が表示されるか確認
- [ ] QRコードが表示されるか確認
- [ ] ピックアップ機能が動作するか確認

---

## 連絡事項

### 保存時のエラー情報が必要

次回再開時に以下の情報を共有してください：

1. **ブラウザコンソールの出力**
   - 「カタログを保存」クリック後のすべてのメッセージ
   - 特に赤色で表示されるエラーメッセージ

2. **どこまで処理が進んだか**
   ```
   ✓ カタログ保存開始
   ✓ 選択されたアイテムID: [...]
   ✓ 保存処理を実行中...
   ✗ 保存完了 ← ここまで表示されなかった
   ```

3. **Firebase接続状態**
   - コンソールに Firebase 関連のエラーがあるか

この情報があれば、すぐに問題を特定して解決できます。

---

## 連絡先・参考資料

### ドキュメント
- Claude Code公式ドキュメント: https://docs.claude.com/en/docs/claude-code
- Firebase公式ドキュメント: https://firebase.google.com/docs

### 既存ドキュメント
- `CURRENT_STATUS.md` - システム全体の状況
- `cors.json` - Firebase Storage CORS設定（本番環境用）

---

**引き継ぎ担当者へ:**
このドキュメントを読んだ後、まず「再開時のチェックリスト」を実行してください。
その後、「次に進めること」の順番で作業を進めてください。

不明点があれば、このドキュメントの該当セクションを参照するか、
コンソールのエラーメッセージを確認してください。

**お疲れさまでした。次回のセッションで引き続き作業を進めましょう。**
