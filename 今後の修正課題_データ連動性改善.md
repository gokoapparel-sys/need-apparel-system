# 今後の修正課題：データ連動性改善

**作成日**: 2025年11月2日
**対象システム**: GOKO アパレル商品管理システム

---

## 概要

現在、アイテム・生地・型紙の各マスタ間で連動性が不十分な状態です。
本ドキュメントでは、データの一貫性を保ち、入力ミスを防ぐための改善案を整理します。

---

## 1. 現状の問題点

### 1-1. 生地マスタとアイテムの連動性なし

**現在の実装:**
```typescript
// アイテム型 (src/types/index.ts)
export interface Item {
  fabricNo?: string      // 単なる文字列フィールド
  composition?: string   // 混率（生地マスタと重複）
  // ...
}

// 生地型 (src/types/index.ts)
export interface Fabric {
  fabricCode: string
  fabricName: string
  composition: string    // アイテムと重複している情報
  price: number
  manufacturer: string
  // ...
}
```

**問題点:**
- ✗ 生地番号を手動入力するため、タイプミスのリスク
- ✗ 存在しない生地番号を入力できてしまう
- ✗ 生地マスタで情報を変更しても既存アイテムに反映されない
- ✗ 混率が二重管理（Item.composition と Fabric.composition）
- ✗ 生地の詳細情報（メーカー、価格等）を参照できない

### 1-2. 型紙マスタとアイテムの連動性（部分的）

**現在の実装:**
```typescript
export interface Item {
  patternId?: string     // 型紙IDで参照可能
  patternNo?: string     // 型紙No.（表示用）
  // ...
}
```

**状況:**
- ◯ `patternId` で型紙マスタを参照可能な構造
- △ 実際の連動機能（選択UI、自動補完等）は未実装

---

## 2. 検討が必要な項目

### 2-1. アイテム登録時の項目見直し

**現在のアイテム項目:**
| 項目名 | 型 | 備考 |
|--------|-----|------|
| itemNo | string | 品番（必須） |
| name | string | アイテム名（必須） |
| fabricNo | string | 生地No.（**文字列入力**） |
| composition | string | 混率（**生地と重複**） |
| dollarPrice | number | ＄単価 |
| moq | string | 単価枚数条件 |
| referencePrice | number | 売単価（参考） |
| factory | string | 工場名 |
| sizeOptions | string | サイズ展開 |
| colorOptions | string | 色展開 |
| patternId | string | 型紙ID |
| patternNo | string | 型紙No. |
| images | array | 画像 |

**検討ポイント:**
- [ ] `fabricNo` を文字列のままにするか、`fabricId` に変更するか
- [ ] `composition` を残すか、生地マスタから取得するか
- [ ] 生地情報の上書き可否（マスタ優先 or 個別設定可能）

### 2-2. 生地登録の基本情報確認

**現在の生地マスタ項目:**
| 項目名 | 型 | 備考 |
|--------|-----|------|
| fabricCode | string | 生地コード（必須） |
| fabricName | string | 生地名（必須） |
| composition | string | 混率 |
| price | number | 価格 |
| manufacturer | string | メーカー |
| fabricType | object | 布帛/カット、無地/先染 |
| managerId | string | 担当者ID |

**検討ポイント:**
- [ ] 必要な項目が揃っているか
- [ ] 追加すべき項目はないか（例：ロット数、リードタイム等）
- [ ] 価格の単位・基準の明確化

### 2-3. 型紙登録の基本情報確認

**現在の型紙マスタ項目:**
| 項目名 | 型 | 備考 |
|--------|-----|------|
| patternCode | string | 型紙コード（必須） |
| patternName | string | 型紙名（必須） |
| files.spec | object | 仕様書ファイル |
| files.layout | object | 展開図ファイル |
| files.data | object | 型紙データ（DXF/AI/CDR等） |
| managerId | string | 担当者ID |

**検討ポイント:**
- [ ] 現状の項目で十分か
- [ ] サイズ情報の管理方法

---

## 3. 連動性改善の実装パターン案

### パターンA：完全連動型（推奨）

**概要:**
- アイテム登録時に生地マスタと型紙マスタから選択
- 関連情報は自動取得
- データの一貫性が最も高い

**実装イメージ:**
```typescript
export interface Item {
  itemNo: string
  name: string
  fabricId: string       // ← 生地IDで紐付け
  patternId: string      // ← 型紙IDで紐付け
  // composition は削除（生地マスタから取得）
  // fabricNo は削除（生地マスタから取得）
  // ...
}
```

**メリット:**
- ✓ タイプミス防止
- ✓ 存在しない生地/型紙を選択できない
- ✓ 生地マスタ更新時に最新情報を参照可能
- ✓ データの一貫性が保たれる

**デメリット:**
- ✗ 必ず生地マスタ・型紙マスタへの登録が必要
- ✗ 既存データの移行が必要
- ✗ 柔軟性が低い（特殊ケース対応が困難）

---

### パターンB：参照型（現状改善版）

**概要:**
- 生地No./型紙No.入力時にマスタを検索
- 存在する場合は情報を自動補完
- ただし手動での上書き可能

**実装イメージ:**
```typescript
export interface Item {
  itemNo: string
  name: string
  fabricNo: string       // ← 文字列のまま（入力時にマスタ検索）
  fabricId?: string      // ← マスタにある場合は参照
  composition: string    // ← マスタから取得、上書き可能
  patternNo: string
  patternId?: string
  // ...
}
```

**メリット:**
- ✓ 柔軟性が高い（特殊ケースにも対応可）
- ✓ 既存データとの互換性が高い
- ✓ 段階的な移行が可能

**デメリット:**
- △ データの一貫性は完全ではない
- △ ユーザーが上書きした場合、マスタと不一致になる

---

### パターンC：現状維持（自由入力）

**概要:**
- 現在のまま文字列入力を継続
- 既存システムとの互換性を最優先

**メリット:**
- ✓ 既存データの移行不要
- ✓ 柔軟性が最も高い

**デメリット:**
- ✗ タイプミス・入力ミスのリスク
- ✗ データの一貫性なし
- ✗ 生地マスタの活用が限定的

---

## 4. 既存データとの互換性

### 4-1. データ移行の必要性

**パターンAを選択した場合:**
- 既存アイテムの `fabricNo` → `fabricId` への変換が必要
- 生地マスタに存在しない生地番号の場合、事前登録が必要

**パターンBを選択した場合:**
- 既存データはそのまま使用可能
- 新規登録時から新方式を適用

### 4-2. 移行手順（パターンA採用時）

1. **生地マスタの整備**
   - 現在使用中の全生地を生地マスタに登録
   - 重複チェック・データクレンジング

2. **アイテムデータの変換**
   - `fabricNo` → 生地マスタを検索 → `fabricId` を設定
   - マッチングしないデータは手動確認

3. **型定義の変更**
   - Item型から `fabricNo`, `composition` を削除
   - `fabricId` を必須化

4. **UI/フォームの改修**
   - 生地選択をドロップダウン/検索式に変更
   - 混率の自動表示機能追加

---

## 5. 推奨される実装順序

### フェーズ1：準備（1-2週間）
- [ ] 運用フローの確認（生地登録タイミング、担当者等）
- [ ] 連動パターンの決定（A/B/Cから選択）
- [ ] 既存データの棚卸し（使用中の生地・型紙リスト作成）

### フェーズ2：マスタデータ整備（1-2週間）
- [ ] 生地マスタへの既存生地登録
- [ ] 型紙マスタへの既存型紙登録
- [ ] データの重複チェック・クレンジング

### フェーズ3：システム改修（2-3週間）
- [ ] 型定義の変更
- [ ] データベーススキーマの更新
- [ ] アイテム登録フォームのUI改修
- [ ] 生地/型紙選択機能の実装
- [ ] 自動補完機能の実装

### フェーズ4：データ移行（1週間）
- [ ] 既存アイテムデータの変換スクリプト作成
- [ ] テスト環境での移行テスト
- [ ] 本番環境での移行実施
- [ ] 移行結果の検証

### フェーズ5：運用開始・調整（継続）
- [ ] ユーザートレーニング
- [ ] 問題点の洗い出し・修正
- [ ] 運用マニュアルの更新

---

## 6. 検討事項チェックリスト

### システム設計
- [ ] 連動パターンの決定（A/B/C）
- [ ] アイテム項目の見直し・確定
- [ ] 生地マスタ項目の見直し・確定
- [ ] 型紙マスタ項目の見直し・確定
- [ ] データ移行方針の決定

### 運用フロー
- [ ] 生地登録のタイミング（アイテム登録前？後？）
- [ ] 型紙登録のタイミング
- [ ] データ管理の責任者・担当者
- [ ] 承認フローの有無

### ユーザビリティ
- [ ] 生地選択UIの形式（ドロップダウン/検索/オートコンプリート）
- [ ] 型紙選択UIの形式
- [ ] 入力補助機能（候補表示、プレビュー等）
- [ ] エラーチェック・バリデーション

### データ管理
- [ ] 既存データのバックアップ方針
- [ ] マスタデータの更新頻度
- [ ] データの削除ルール（アイテムで使用中の生地は削除不可等）

---

## 7. 次のステップ

1. **管理者会議で検討**
   - 本ドキュメントをもとに実装パターンを決定
   - 優先順位・スケジュールの確認

2. **詳細設計**
   - 決定した実装パターンに基づく詳細設計
   - 画面レイアウト・UIの確定

3. **開発着手**
   - システム改修の実施
   - テスト・検証

---

## 参考情報

### 関連ファイル
- **型定義**: `src/types/index.ts`
- **アイテムフォーム**: `src/pages/items/ItemForm.tsx`
- **生地フォーム**: `src/pages/fabrics/FabricForm.tsx`
- **型紙フォーム**: `src/pages/patterns/PatternForm.tsx`

### 現在のデータ構造
```
アイテム (Item)
├── fabricNo: string (文字列)  ← 生地マスタと未連動
├── composition: string        ← 生地と重複
├── patternId: string          ← 型紙マスタと部分連動
└── patternNo: string

生地 (Fabric)
├── fabricCode: string
├── fabricName: string
├── composition: string        ← アイテムと重複
└── ...

型紙 (Pattern)
├── patternCode: string
├── patternName: string
└── ...
```

---

**備考:**
このドキュメントは今後の改善検討用の資料です。
実装時期や優先順位は、運用状況と照らし合わせて管理者にて判断してください。

---

**作成者**: Claude (AI Assistant)
**最終更新**: 2025年11月2日
